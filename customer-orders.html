<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesanan Saya - My Casual</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .orders-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .orders-header h1 {
            font-size: 1.75rem;
            color: #1f2937;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }

        .filter-btn:hover {
            border-color: #6366f1;
        }

        .orders-list {
            display: grid;
            gap: 1.5rem;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .order-card-header {
            background: linear-gradient(135deg, #f3f4f6 0%, #f9fafb 100%);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-id {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .order-date {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .order-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef08a;
            color: #854d0e;
        }

        .status-settlement,
        .status-capture {
            background: #dcfce7;
            color: #166534;
        }

        .status-cancel,
        .status-deny,
        .status-expire {
            background: #fee2e2;
            color: #991b1b;
        }

        .order-card-body {
            padding: 1.5rem;
        }

        .order-items {
            margin-bottom: 1.5rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #1f2937;
        }

        .item-qty {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .item-price {
            font-weight: 600;
            color: #6366f1;
        }

        .order-summary {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .summary-row.total {
            border-top: 1px solid #e5e7eb;
            padding-top: 0.75rem;
            font-weight: 700;
            color: #1f2937;
        }

        .order-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-detail {
            background: #6366f1;
            color: white;
        }

        .btn-detail:hover {
            background: #4f46e5;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #ef4444;
            border: 1px solid #e5e7eb;
        }

        .btn-cancel:hover {
            background: #fee2e2;
        }

        .btn-pay {
            background: #10b981;
            color: white;
        }

        .btn-pay:hover {
            background: #059669;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .empty-state a {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #6366f1;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .empty-state a:hover {
            background: #4f46e5;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <h1 class="brand">My Casual</h1>
            <nav class="nav">
                <a href="index.html">Beranda</a>
                <a href="index.html#produk">Produk</a>
                <a href="customer-profile.html">Profil</a>
            </nav>
            <button class="cart-btn" id="openCart">
                <i class="fas fa-shopping-cart"></i> <span id="cartCount">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="orders-container">
        <div class="orders-header">
            <h1>Pesanan Saya</h1>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-list"></i> Semua
                </button>
                <button class="filter-btn" data-filter="pending">
                    <i class="fas fa-clock"></i> Pending
                </button>
                <button class="filter-btn" data-filter="settlement">
                    <i class="fas fa-check"></i> Selesai
                </button>
                <button class="filter-btn" data-filter="cancel">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        </div>

        <div class="orders-list" id="ordersList">
            <!-- Orders will be loaded here -->
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-shopping-bag"></i>
            <p>Belum ada pesanan</p>
            <a href="index.html">Mulai Berbelanja</a>
        </div>
    </main>

    <script src="https://app.sandbox.midtrans.com/snap/snap.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let allOrders = [];
        let currentFilter = 'all';

        function fmt(n) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                maximumFractionDigits: 0
            }).format(n);
        }

        function getStatusBadge(status) {
            const statusClass = {
                'pending': 'status-pending',
                'settlement': 'status-settlement',
                'capture': 'status-settlement',
                'cancel': 'status-cancel',
                'deny': 'status-cancel',
                'expire': 'status-cancel'
            };

            const statusLabel = {
                'pending': 'Pending',
                'settlement': 'Selesai',
                'capture': 'Selesai',
                'cancel': 'Batal',
                'deny': 'Ditolak',
                'expire': 'Kadaluarsa'
            };

            return `<span class="order-status ${statusClass[status] || 'status-pending'}">${statusLabel[status] || status}</span>`;
        }

        async function loadOrders() {
            try {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');

                if (!token || !user.id) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    allOrders = result.data || [];
                    renderOrders();
                } else {
                    console.error('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');

            let filteredOrders = allOrders;
            if (currentFilter !== 'all') {
                filteredOrders = allOrders.filter(order => order.status === currentFilter);
            }

            if (filteredOrders.length === 0) {
                ordersList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            ordersList.style.display = 'grid';
            emptyState.style.display = 'none';

            ordersList.innerHTML = filteredOrders.map(order => `
                <div class="order-card">
                    <div class="order-card-header">
                        <div>
                            <div class="order-id">#${order.orderId}</div>
                            <div class="order-date">${new Date(order.createdAt).toLocaleString('id-ID')}</div>
                        </div>
                        ${getStatusBadge(order.status)}
                    </div>
                    <div class="order-card-body">
                        <div class="order-items">
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <div>
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-qty">Jumlah: ${item.quantity}</div>
                                    </div>
                                    <div class="item-price">${fmt(item.price * item.quantity)}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span>${fmt(order.subtotal)}</span>
                            </div>
                            ${order.discount > 0 ? `
                                <div class="summary-row">
                                    <span>Diskon:</span>
                                    <span style="color: #10b981;">-${fmt(order.discount)}</span>
                                </div>
                            ` : ''}
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span style="color: #6366f1;">${fmt(order.total)}</span>
                            </div>
                        </div>
                        <div class="order-actions">
                            <button class="action-btn btn-detail" onclick="showOrderDetail('${order.orderId}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                            ${order.status === 'pending' ? `
                                <button class="action-btn btn-pay" onclick="payOrder('${order.orderId}')">
                                    <i class="fas fa-credit-card"></i> Bayar
                                </button>
                                <button class="action-btn btn-cancel" onclick="cancelOrder('${order.orderId}')">
                                    <i class="fas fa-times"></i> Batal
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showOrderDetail(orderId) {
            const order = allOrders.find(o => o.orderId === orderId);
            if (!order) return;

            Swal.fire({
                title: 'Detail Pesanan',
                html: `
                    <div style="text-align: left;">
                        <p><strong>Order ID:</strong> ${order.orderId}</p>
                        <p><strong>Status:</strong> ${order.status}</p>
                        <p><strong>Total:</strong> ${fmt(order.total)}</p>
                        <p><strong>Tanggal:</strong> ${new Date(order.createdAt).toLocaleString('id-ID')}</p>
                    </div>
                `,
                confirmButtonColor: '#6366f1'
            });
        }

        async function payOrder(orderId) {
            const order = allOrders.find(o => o.orderId === orderId);
            if (!order) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Pesanan tidak ditemukan'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Memproses Pembayaran...',
                    html: 'Mohon tunggu...',
                    icon: 'info',
                    allowOutsideClick: false,
                    didOpen: async () => {
                        Swal.showLoading();

                        // Create transaction for Midtrans
                        const token = localStorage.getItem('token');
                        const user = JSON.parse(localStorage.getItem('user') || '{}');

                        // Format items untuk Midtrans
                        const formattedItems = order.items.map(item => ({
                            id: item.id || item.productId,
                            price: item.price,
                            quantity: item.quantity,
                            name: item.name
                        }));

                        const paymentData = {
                            orderId: order.orderId,
                            amount: order.total,
                            items: formattedItems,
                            customer: {
                                first_name: user.name ? user.name.split(' ')[0] : user.email.split('@')[0],
                                last_name: user.name ? user.name.split(' ').slice(1).join(' ') || user.name.split(' ')[0] : user.email.split('@')[0],
                                email: user.email,
                                phone: user.phone || ''
                            },
                            userId: user.id
                        };

                        const snapResponse = await fetch(`${API_BASE_URL}/api/payment/create-transaction`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(paymentData)
                        });

                        if (!snapResponse.ok) {
                            const errorData = await snapResponse.json();
                            throw new Error(errorData.message || 'Failed to create payment transaction');
                        }

                        const snapData = await snapResponse.json();
                        const snapToken = snapData.data.token;

                        Swal.close();

                        // Open Midtrans payment
                        window.snap.pay(snapToken, {
                            onSuccess: async function (result) {
                                console.log("Pembayaran sukses:", result);

                                // Update order status di backend
                                try {
                                    await fetch(`${API_BASE_URL}/api/payment/status/${result.order_id}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            status: 'settlement',
                                            paymentType: result.payment_type
                                        })
                                    });
                                } catch (error) {
                                    console.error('Error updating order status:', error);
                                }

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Pembayaran Berhasil!',
                                    text: 'Pesanan Anda telah dikonfirmasi. Terimakasih sudah berbelanja!',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                loadOrders();
                            },
                            onPending: function (result) {
                                console.log("Pembayaran pending:", result);
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Pembayaran Tertunda',
                                    text: 'Pembayaran Anda sedang diproses. Mohon menunggu...'
                                });
                                loadOrders();
                            },
                            onError: function (result) {
                                console.error("Pembayaran gagal:", result);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Pembayaran Gagal',
                                    text: 'Pembayaran Anda gagal diproses. Silakan coba lagi.'
                                });
                                loadOrders();
                            },
                            onClose: function () {
                                console.log("Modal ditutup tanpa proses");
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Terjadi kesalahan saat memproses pembayaran: ' + error.message
                });
            }
        }

        async function cancelOrder(orderId) {
            const result = await Swal.fire({
                title: 'Batalkan Pesanan?',
                text: 'Pesanan akan dihapus dan tidak dapat dipulihkan. Hanya pesanan dengan status "Pending" yang dapat dibatalkan.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Batalkan dan Hapus',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: 'Menghapus Pesanan...',
                        icon: 'info',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Pesanan Dihapus',
                            text: 'Pesanan Anda telah berhasil dihapus dari sistem',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        loadOrders();
                    } else {
                        const errorData = await response.json();
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal Menghapus Pesanan',
                            text: errorData.message || 'Terjadi kesalahan saat menghapus pesanan'
                        });
                    }
                } catch (error) {
                    console.error('Error canceling order:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Terjadi kesalahan: ' + error.message
                    });
                }
            }
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderOrders();
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>

</html>